<!DOCTYPE html>
<html lang="en">
<head>
    <title>M3U8 Player - Embedded Video Player</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Embedded M3U8 Player for streaming HLS videos">
    <script src="https://cdn.staticfile.org/jquery/3.6.0/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://web.sdk.qcloud.com/player/tcplayer/release/v5.1.0/tcplayer.min.css" rel="stylesheet" />
    <script src="https://web.sdk.qcloud.com/player/tcplayer/release/v5.1.0/tcplayer.v5.1.0.min.js"></script>
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-hover: #1d4ed8;
            --secondary-color: #64748b;
            --background-color: #ffffff;
            --surface-color: #f8fafc;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        [data-theme="dark"] {
            --primary-color: #3b82f6;
            --primary-hover: #2563eb;
            --secondary-color: #94a3b8;
            --background-color: #0f172a;
            --surface-color: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: #334155;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.3), 0 1px 2px -1px rgb(0 0 0 / 0.3);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.3), 0 4px 6px -4px rgb(0 0 0 / 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            width: 100%;
            height: 100%;
            background-color: var(--background-color);
            transition: background-color 0.3s ease;
        }

        body {
            width: 100%;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
            overflow: hidden;
        }

        html[data-theme="dark"] {
            background-color: var(--background-color);
        }

        .player-container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: var(--background-color);
        }

        .player-header {
            background: var(--surface-color);
            padding: 0.5rem 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 50px;
        }

        .player-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .player-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .theme-toggle {
            background: var(--primary-color);
            border: none;
            color: white;
            padding: 0.4rem;
            border-radius: 0.4rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
            font-size: 0.875rem;
        }

        .theme-toggle:hover {
            background: var(--primary-hover);
        }

        .video-wrapper {
            flex: 1;
            background: #000;
            position: relative;
            overflow: hidden;
        }

        #player-container-id {
            width: 100%;
            height: 100%;
        }

        .error-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            text-align: center;
            max-width: 90%;
            z-index: 10;
        }

        .error-message h3 {
            margin-bottom: 1rem;
            color: #ef4444;
        }

        .error-message p {
            margin-bottom: 0.5rem;
            line-height: 1.5;
        }

        .loading-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 5;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .url-display {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-left: 1rem;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        @media (max-width: 768px) {
            .player-header {
                padding: 0.4rem 0.8rem;
                min-height: 45px;
            }

            .player-title {
                font-size: 0.9rem;
            }

            .url-display {
                display: none;
            }

            .theme-toggle {
                padding: 0.3rem;
                font-size: 0.8rem;
            }
        }

        /* 隐藏播放器头部以适应iframe嵌入 */
        .embedded .player-header {
            display: none;
        }

        .embedded .video-wrapper {
            height: 100vh;
        }
    </style>
</head>

<body>
    <div class="player-container">
        <div class="player-header">
            <div class="player-title">M3U8 Player</div>
            <div class="url-display" id="url-display"></div>
            <div class="player-controls">
                <button class="theme-toggle" onclick="toggleTheme()" title="Toggle dark mode">
                    <span id="theme-icon"><i class="fas fa-moon"></i></span>
                </button>
            </div>
        </div>
        
        <div class="video-wrapper">
            <div class="loading-spinner" id="loading-spinner">
                <div class="spinner"></div>
            </div>
            
            <div class="error-message" id="error-message" style="display: none;">
                <h3><i class="fas fa-exclamation-triangle"></i> 播放错误</h3>
                <p id="error-text">无法加载视频流</p>
                <p>请检查视频URL是否正确或稍后重试</p>
            </div>
            
            <video id="player-container-id" preload="auto" playsinline webkit-playsinline>
            </video>
        </div>
    </div>

    <script>
        var player = undefined;
        var videoUrl = '';
        
        // 暗黑模式切换功能
        function toggleTheme() {
            const html = document.documentElement;
            const body = document.body;
            const themeIcon = document.getElementById('theme-icon');
            const currentTheme = body.getAttribute('data-theme');
            
            if (currentTheme === 'dark') {
                body.removeAttribute('data-theme');
                html.removeAttribute('data-theme');
                themeIcon.innerHTML = '<i class="fas fa-moon"></i>';
                localStorage.setItem('player-theme', 'light');
            } else {
                body.setAttribute('data-theme', 'dark');
                html.setAttribute('data-theme', 'dark');
                themeIcon.innerHTML = '<i class="fas fa-sun"></i>';
                localStorage.setItem('player-theme', 'dark');
            }
        }
        
        // 获取URL参数
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }
        
        // 显示错误信息
        function showError(message) {
            const errorElement = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            const loadingSpinner = document.getElementById('loading-spinner');
            
            loadingSpinner.style.display = 'none';
            errorText.textContent = message;
            errorElement.style.display = 'block';
        }
        
        // 隐藏错误信息
        function hideError() {
            const errorElement = document.getElementById('error-message');
            errorElement.style.display = 'none';
        }
        
        // 隐藏加载动画
        function hideLoading() {
            const loadingSpinner = document.getElementById('loading-spinner');
            loadingSpinner.style.display = 'none';
        }
        
        // 初始化播放器
        function initPlayer(url) {
            if (!url) {
                showError('未提供视频URL参数');
                return;
            }
            
            // 验证URL格式
            try {
                new URL(url);
            } catch (e) {
                showError('无效的视频URL格式');
                return;
            }
            
            videoUrl = url;
            
            // 更新URL显示
            const urlDisplay = document.getElementById('url-display');
            urlDisplay.textContent = url;
            urlDisplay.title = url;
            
            try {
                player = TCPlayer('player-container-id', {
                    sources: [{
                        src: url,
                    }],
                    // licenseUrl需自己去腾讯云申请
                    licenseUrl: 'https://license.vod2.myqcloud.com/license/v2/1252819296_1/v_cube.license',
                    autoplay: true,
                    controls: true,
                    fluid: true,
                    responsive: true,
                    playbackRates: [0.5, 1, 1.25, 1.5, 2],
                    language: 'zh-CN'
                });
                
                // 监听播放器事件
                player.ready(function() {
                    console.log('Player is ready');
                    hideLoading();
                    hideError();
                });
                
                player.on('error', function(error) {
                    console.error('Player error:', error);
                    showError('视频加载失败，请检查网络连接或视频源');
                });
                
                player.on('loadstart', function() {
                    console.log('Loading started');
                    hideError();
                });
                
                player.on('canplay', function() {
                    console.log('Can start playing');
                    hideLoading();
                });
                
                // 设置超时检测
                setTimeout(function() {
                    if (player && player.readyState() === 0) {
                        showError('视频加载超时，请检查网络连接');
                    }
                }, 15000);
                
            } catch (error) {
                console.error('Failed to initialize player:', error);
                showError('播放器初始化失败');
            }
        }
        
        // 检测是否在iframe中
        function isInIframe() {
            try {
                return window.self !== window.top;
            } catch (e) {
                return true;
            }
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 恢复主题设置
            const savedTheme = localStorage.getItem('player-theme');
            const themeIcon = document.getElementById('theme-icon');
            const html = document.documentElement;
            const body = document.body;
            
            if (savedTheme === 'dark') {
                body.setAttribute('data-theme', 'dark');
                html.setAttribute('data-theme', 'dark');
                themeIcon.innerHTML = '<i class="fas fa-sun"></i>';
            } else {
                themeIcon.innerHTML = '<i class="fas fa-moon"></i>';
            }
            
            // 如果在iframe中，添加embedded类
            if (isInIframe()) {
                document.body.classList.add('embedded');
            }
            
            // 获取URL参数并初始化播放器
            const url = getUrlParameter('url');
            if (url) {
                // URL解码
                const decodedUrl = decodeURIComponent(url);
                initPlayer(decodedUrl);
            } else {
                showError('请在URL中提供视频地址参数，例如：player.html?url=https://example.com/video.m3u8');
            }
        });
        
        // 处理窗口大小变化
        window.addEventListener('resize', function() {
            if (player) {
                player.fluid(true);
            }
        });
        
        // 防止右键菜单（可选）
        document.addEventListener('contextmenu', function(e) {
            if (isInIframe()) {
                e.preventDefault();
            }
        });
    </script>
</body>
</html>